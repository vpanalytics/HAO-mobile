<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAO Controle de Vendas </title>
    
    <!-- Biblioteca Chart.js para os gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Biblioteca para gerar imagem PNG -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Plugin para rótulos de dados nos gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
        <!-- ... outros scripts como Chart.js ... -->

    <!-- NOVOS SCRIPTS DO FIREBASE -->
    <!-- O App principal do Firebase (sempre necessário) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <!-- Carrega o serviço do Firestore (banco de dados ) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>

    <!-- Fonte do Google para um visual mais moderno -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
    /* ============== ESTILOS GERAIS (CSS  ) ============== */
    :root {
        --primary-color: #0052cc;
        --primary-light: #e6f0ff;
        --secondary-color: #5E6C84;
        --danger-color: #dc3545;
        --success-color: #00875A;
        --warning-color: #ffab00;
        
        --bg-color: #f4f5f7;
        --card-bg-color: #ffffff;
        --text-color: #172B4D;
        --border-color: #dfe1e6;
        --shadow: 0px 4px 8px rgba(9, 30, 66, 0.06), 0px 0px 1px rgba(9, 30, 66, 0.31);
        --font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    body {
        font-family: var(--font-family);
        margin: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        transition: background-color 0.3s, color 0.3s;
    }

    .hidden {
        display: none !important;
    }

    /* ============== ANIMAÇÃO DE FUNDO (TELA DE LOGIN) ============== */
    @keyframes smoke-animation {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    .login-screen-wrapper {
        /* ALTERAÇÃO: Tira a tela de login do fluxo normal da página */
        position: fixed; 
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1; /* Mantém na camada de trás */  
        background: linear-gradient(-45deg, #000000, #222222, #444444, #111111, #000000);
        background-size: 400% 400%;
        animation: smoke-animation 25s ease infinite;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
    }
    
    .login-page-container {
        width: 100%;
        max-width: 950px;
        background-color: var(--card-bg-color);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        overflow: hidden;
        display: flex;
        flex-direction: row;
    }

    .login-container {
        flex: 1.2;
        padding: 50px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .login-header {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 30px;
    }

    .login-container h1 {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-color);
    }

    .login-container p {
        color: var(--secondary-color);
        margin-bottom: 30px;
        font-size: 1rem;
    }
    
    #login-error, #produto-error-msg, #loja-error-msg {
        color: var(--danger-color);
        background-color: #ffebee;
        border: 1px solid var(--danger-color);
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 15px;
        text-align: center;
    }
    
    #loja-success-msg {
        color: var(--success-color);
        background-color: #e8f5e9;
        border: 1px solid var(--success-color);
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 15px;
        text-align: center;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        font-size: 0.9rem;
    }

    input[type="text"],
    input[type="password"],
    input[type="date"],
    input[type="number"],
    select {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-sizing: border-box;
        font-family: var(--font-family);
        font-size: 1rem;
        transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s, color 0.3s;
    }
    
    input:focus, select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-light);
    }

    button[type="submit"] {
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 8px;
        background-color: var(--primary-color);
        color: white;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    button[type="submit"]:hover {
        background-color: #0041a3;
    }

    .login-image-container {
        flex: 1.6;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 0%;
        overflow: hidden;
    }


    /* ============== ESTILOS DA TELA PRINCIPAL (DASHBOARD) ============== */
    .app-container {
        position: relative;
        z-index: 2;
        background-color: var(--bg-color); /* ADICIONE/GARANTA ESTA LINHA */  
        width: 100%;
        max-width: 1500px;
        padding: 20px;
        box-sizing: border-box;
        margin: 0 auto;
    }

    .main-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--card-bg-color);
        padding: 15px 30px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        margin-bottom: 25px;
    }
    
    .header-title-container {
        display: flex;
        align-items: center;
        gap: 20px;
    }
    .header-title-container h2 {
        margin: 0;
    }
    
    .header-controls {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .main-header nav ul {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        background-color: var(--bg-color);
        border-radius: 8px;
        padding: 5px;
    }

    .main-header nav a {
        text-decoration: none;
        color: var(--secondary-color);
        padding: 8px 18px;
        border-radius: 6px;
        font-weight: 500;
        transition: background-color 0.3s, color 0.3s;
    }

    .main-header nav a.active-tab {
        background-color: var(--primary-color);
        color: white;
        box-shadow: 0 2px 4px rgba(0, 82, 204, 0.3);
    }
    
    #logout-btn {
        padding: 8px 16px;
        border: none;
        background-color: var(--danger-color);
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        font-family: var(--font-family);
        transition: background-color 0.3s;
    }
    
    #logout-btn:hover {
        background-color: #b02a37;
    }

    .tab-content {
        display: none;
        animation: fadeIn 0.5s;
    }

    .tab-content.active-content {
        display: block;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* FILTROS */
    .filters-container {
        background-color: var(--card-bg-color);
        padding: 15px 30px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        margin-bottom: 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }
    .filter-group {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    /* CARDS */
    .cards-container {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        gap: 25px;
        margin-bottom: 25px;
    }

    .card {
        background-color: var(--card-bg-color);
        padding: 25px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        border-left: 4px solid #15191d;
    }
    
    /* .card:nth-child(2) { border-left-color: var(--success-color); }
    .card:nth-child(3) { border-left-color: var(--warning-color); }
    .card:nth-child(4) { border-left-color: var(--secondary-color); } */

    .card h3 {
        margin: 0 0 10px 0;
        font-size: 1rem;
        font-weight: 500;
        color: var(--secondary-color);
    }

    .card p {
        margin: 0;
        font-size: 2.2rem;
        font-weight: 600;
        color: var(--text-color);
    }
    
    /* GRÁFICOS */
    .charts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 25px;
        margin-bottom: 25px;
    }

    .chart-wrapper canvas {
        position: relative;
        width: 100% !important;
        height: 92% !important;
    }

    .chart-wrapper {
        background-color: var(--card-bg-color);
        padding: 25px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        height: 350px;
        display: flex;
        flex-direction: column;
        position: relative;
        min-height: 0;
    }

    .chart-wrapper-tall {
        height: 450px;
    }

    .chart-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 20px;
        text-align: center;
    }

    /* FORMULÁRIOS DE CADASTRO E LANÇAMENTO */
    form {
        background-color: var(--card-bg-color);
        padding: 30px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px 25px;
        align-items: flex-end;
    }
    
    form h2 {
        grid-column: 1 / -1;
        margin: 0 0 10px 0;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
    }
    
    hr {
        border: none;
        border-top: 1px solid var(--border-color);
        margin: 40px 0;
    }

    /* TABELAS */
    .table-wrapper {
        background-color: var(--card-bg-color);
        padding: 10px;
        border-radius: 12px;
        box-shadow: var(--shadow);
    }
    
    .table-container {
        max-height: 400px;
        overflow-y: auto;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }

   thead th {
    background-color: #2c3846;  /* <-- ESTA É A COR DO CABEÇALHO */
    color: white;
    font-weight: 600;
    position: sticky;
    top: 0;
}

    tbody tr:hover {
        background-color: #f4f5f7;
    }
    
    section > h2, .table-header-controls h2 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 20px;
    }
    
    /* Botões de Ação nas Tabelas (Editar/Excluir) */
    .actions-cell {
        display: flex;
        gap: 10px;
    }
    .btn-table-action {
        padding: 5px 10px;
        font-size: 0.8rem;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.3s, color 0.3s;
        border: 1px solid transparent;
    }
    .btn-table-edit {
        border-color: var(--warning-color);
        background-color: transparent;
        color: var(--warning-color);
    }
    .btn-table-edit:hover {
        background-color: var(--warning-color);
        color: white;
    }
    .btn-table-delete {
        border-color: var(--danger-color);
        background-color: transparent;
        color: var(--danger-color);
    }
    .btn-table-delete:hover {
        background-color: var(--danger-color);
        color: white;
    }

    /* Botão de Cancelar Padronizado */
    .btn-cancel {
        background-color: var(--secondary-color);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 14px 20px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.3s;
    }
    .btn-cancel:hover {
        background-color: #495568;
    }

    /* Contêiner de Ações do Formulário */
    .form-actions {
        grid-column: 4 / 5;
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        align-items: center;
    }
    .form-actions button {
        width: auto;
        padding: 14px 20px;
    }
    
    /* Header da Tabela de Vendas (Título + Exportar) */
    .table-header-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .table-header-controls h2 {
        margin: 0;
    }
    #export-vendas-btn, #share-pdf-btn {
        background-color: var(--success-color);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 18px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    #export-vendas-btn:hover, #share-pdf-btn:hover {
        background-color: #006a48;
    }
    
    /* Estilos para o modo de edição */
    form.editing-mode input, form.editing-mode select {
        background-color: var(--primary-light) !important;
        border-color: var(--primary-color) !important;
    }

    /* Layout em Grid para o formulário de Vendas */
    .form-vendas-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 20px 25px;
    }
    .form-vendas-grid h2 { grid-column: 1 / -1; }
    .form-vendas-grid .form-actions { grid-column: 4 / 5; }

    /* Estilo para Rádio Buttons customizados */
    .radio-group {
        display: flex;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        width: fit-content;
        height: 45px;
        box-sizing: border-box;
    }
    .radio-group input[type="radio"] {
        display: none;
    }
    .radio-group label {
        padding: 12px 18px;
        cursor: pointer;
        margin: 0;
        transition: background-color 0.3s, color 0.3s;
        color: var(--secondary-color);
        font-weight: 500;
        display: flex;
        align-items: center;
    }
    .radio-group input[type="radio"]:checked + label {
        background-color: var(--primary-color);
        color: white;
    }

    /* Alinhamento dos botões de formulário (Lojas e Produtos) */
    .form-actions-loja-ajustado {
        grid-column: 2 / -1;
        justify-self: end;
    }
    .form-actions-loja-ajustado button {
        width: auto;
        padding: 14px 25px;
    }

    /* Novo container de gráficos com 3 colunas */
    .charts-container-3-cols {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 25px;
        margin-bottom: 25px;
    }

    /* ============== ESTILOS PARA PRODUTOS ============== */
    #produtos-lista-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .produto-item {
        display: grid;
        grid-template-columns: 1fr 150px 200px 50px 50px;
        align-items: center;
        gap: 20px;
        padding: 10px 15px;
        background-color: var(--card-bg-color);
        border-radius: 8px;
        box-shadow: var(--shadow);
    }
    .produto-item h4 {
        margin: 0;
        font-weight: 500;
    }
    .produto-valor-container {
        display: flex;
        align-items: center;
    }
    .produto-valor-input {
        width: 100%;
        padding: 8px;
    }
    .produto-data-alteracao {
        font-size: 0.85rem;
        color: var(--secondary-color);
    }
    .edit-valor-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 5px;
    }
    .status-dot {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .status-dot.ativo {
        background-color: var(--success-color);
    }
    .status-dot.inativo {
        background-color: var(--danger-color);
    }

    /* ============== MODAL DE CONFIRMAÇÃO ============== */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .modal-content {
        background-color: var(--card-bg-color);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        text-align: center;
        max-width: 400px;
        width: 90%;
    }
    .modal-content p {
        font-size: 1.1rem;
        margin-bottom: 25px;
    }
    .modal-actions {
        display: flex;
        justify-content: center;
        gap: 15px;
    }
    #modal-confirm-btn {
        background-color: var(--primary-color);
        color: white;
    }
    #modal-cancel-btn {
        background-color: var(--secondary-color);
    }
    .modal-actions button {
        padding: 10px 25px;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
    }

    /* ============== ESTILOS PARA O MODO ESCURO (DARK MODE) ============== */
    body.dark-mode {
        --primary-color: #388bff;
        --primary-light: rgba(56, 139, 255, 0.15);
        --secondary-color: #8c9bab;
        
        --bg-color: #111111;
        --card-bg-color: #212b36;
        --text-color: #f0f2f5;
        --border-color: #394451;
        --shadow: 0px 4px 8px rgba(0, 0, 0, 0.1), 0px 0px 1px rgba(0, 0, 0, 0.3);
    }

    
    body.dark-mode .login-page-container {
        --card-bg-color: #ffffff;
        --text-color: #172B4D;
        --secondary-color: #5E6C84;
        --border-color: #dfe1e6;
    }
    body.dark-mode .login-page-container input {
        background-color: #ffffff;
        color: #172B4D;
        border-color: #dfe1e6;
    }
    
    /* Localização da regra para o modo escuro */
body.dark-mode thead th {
    background-color: #2c3846; /* <-- ESTA É A COR DO CABEÇALHO NO MODO ESCURO */
}


    body.dark-mode tbody tr:hover {
        background-color: #2c3846;
    }
    
    body.dark-mode input, body.dark-mode select {
        background-color: #2c3846;
        color: var(--text-color);
        border-color: #2c3846;
    }
    
    body.dark-mode input[readonly] {
        background-color: #394451;
    }

    body.dark-mode #login-error, body.dark-mode #produto-error-msg, body.dark-mode #loja-error-msg { background-color: rgba(220, 53, 69, 0.2); }
    body.dark-mode #loja-success-msg { background-color: rgba(0, 135, 90, 0.2); }
    body.dark-mode .main-header nav ul { background-color: var(--bg-color); }
    body.dark-mode form.editing-mode input, body.dark-mode form.editing-mode select {
        background-color: rgba(56, 139, 255, 0.2) !important;
    }

    body.dark-mode .main-header h2 {
        color: white;
    }

    body.dark-mode .radio-group { border-color: #4a596a; }
    body.dark-mode .radio-group label { color: #8c9bab; }
    body.dark-mode .radio-group input[type="radio"]:checked + label { background-color: var(--primary-color); color: white; }

    /* ============== ESTILOS PARA O BOTÃO DE TEMA ============== */
    #theme-toggle-btn {
        background: none;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        color: var(--secondary-color);
        transition: background-color 0.3s, border-color 0.3s, color 0.3s;
    }
    
    #theme-toggle-btn:hover {
        background-color: var(--primary-light);
        border-color: var(--primary-color);
        color: var(--primary-color);
    }
    
    #theme-toggle-btn svg {
        pointer-events: none;
    }

    /* ================================================================== */
/* BLOCO ÚNICO: CORREÇÃO NO CSS (Alinhamento do Status)             */
/* ================================================================== */

/* ================================================================== */
/* BLOCO ÚNICO: CORREÇÃO NO CSS (Layout da Tabela de Produtos)      */
/* ================================================================== */

/* Define a largura das colunas da tabela de produtos */
#tabela-produtos {
    table-layout: fixed; /* Garante que as larguras sejam respeitadas */
}

#tabela-produtos th:nth-child(1),
#tabela-produtos td:nth-child(1) { width: auto; } /* Modelo (flexível) */

#tabela-produtos th:nth-child(2),
#tabela-produtos td:nth-child(2) { width: 180px; } /* Valor */

#tabela-produtos th:nth-child(3),
#tabela-produtos td:nth-child(3) { width: 80px; text-align: center; } /* Ação (Lápis) */

#tabela-produtos th:nth-child(4),
#tabela-produtos td:nth-child(4) { width: 200px; } /* Última Alteração */

#tabela-produtos th:nth-child(5),
#tabela-produtos td:nth-child(5) { width: 80px; text-align: center; } /* Status (Bolinha) */

/* Garante que o ícone do lápis e o ponto de status fiquem centralizados */
.edit-valor-btn, .status-dot {
    display: inline-block;
    vertical-align: middle;
}

/* ================================================================== */
/* BLOCO 2: ALTERAÇÃO NO CSS (Estilo do Grupo de Filtros)           */
/* ================================================================== */

.filters-container .filter-group {
    display: flex;
    align-items: center;
    gap: 25px; /* Espaçamento entre os filtros */
}
    /* ================================================================== */
    /* NOVOS ESTILOS PARA O GRÁFICO TEMPORAL UNIFICADO */
    /* ================================================================== */
    .chart-canvas-container {
        position: relative;
        flex-grow: 1; /* Faz o contêiner do canvas ocupar o espaço restante */
    }
    .chart-canvas-container canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 92% !important;
    }
    .chart-header-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .chart-toggle-buttons {
        display: flex;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
    }
    .toggle-btn {
        background-color: transparent;
        border: none;
        padding: 6px 14px;
        cursor: pointer;
        color: var(--secondary-color);
        font-weight: 500;
        font-family: var(--font-family);
        transition: background-color 0.3s, color 0.3s;
    }
    .toggle-btn.active {
        background-color: var(--primary-color);
        color: white;
    }
    body.dark-mode .toggle-btn {
        color: var(--text-color);
    }
    body.dark-mode .toggle-btn.active {
        background-color: var(--primary-color);
        color: #fff;
    }

    /* ================================================================== */
    /* NOVOS ESTILOS PARA A LINHA MENSAL/ANUAL */
    /* ================================================================== */
    .charts-row {
        display: flex;
        gap: 25px;
        margin-bottom: 25px;
        flex-wrap: wrap; /* Garante que quebre a linha em telas menores */
    }

    .chart-wrapper-flex {
        background-color: var(--card-bg-color);
        padding: 25px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        height: 350px;
        display: flex;
        flex-direction: column;
        position: relative;
    }
    /* ================================================================== */
    /* NOVOS ESTILOS PARA A TABELA DE DETALHAMENTO DE VENDAS */
    /* ================================================================== */
    .multi-select-filter {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 0;
    }
    .multi-select-filter label {
        font-weight: 500;
        white-space: nowrap;
    }
    #lojas-checkboxes {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }
    #lojas-checkboxes div {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    #lojas-checkboxes label {
        font-weight: 400;
        font-size: 0.9rem;
    }

    #tabela-detalhe-vendas {
        border-collapse: collapse;
        text-align: center;
    }
    #tabela-detalhe-vendas th, 
    #tabela-detalhe-vendas td {
        padding: 10px;
        font-size: 0.85rem;
        min-width: 70px;
        white-space: nowrap;
        border-right: 1px solid var(--border-color);
    }
    #tabela-detalhe-vendas th:last-child, 
    #tabela-detalhe-vendas td:last-child {
        border-right: none;
    }
    #tabela-detalhe-vendas .col-header-loja {
        min-width: 140px; /* Garante espaço para Pçs e $ */
    }
    #tabela-detalhe-vendas .sub-header {
        font-weight: 500;
        font-size: 0.8rem;
    }
    /* ================================================================== */
    /* CORREÇÃO: FIXA A PRIMEIRA COLUNA (DATA/DIA) DA TABELA */
    /* ================================================================== */
    #tabela-detalhe-vendas .row-header-dia {
        text-align: left;
        font-weight: 600;
        position: sticky;
        left: 0; /* Faz a coluna "grudar" na esquerda */
        background-color: var(--card-bg-color); /* Fundo sólido para modo claro */
        z-index: 1; /* Coloca a coluna acima dos dados, mas abaixo do cabeçalho fixo */
        min-width: 150px;
    }

    body.dark-mode #tabela-detalhe-vendas .row-header-dia {
        background-color: #2c3846; /* Fundo sólido para modo escuro */
    }

    #tabela-detalhe-vendas .inauguracao-cell {
        background-color: rgba(255, 171, 0, 0.3); /* Amarelo com transparência */
        color: var(--text-color);
        font-weight: bold;
    }
    .table-legend {
        padding: 10px 15px;
        font-size: 0.8rem;
        color: var(--secondary-color);
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .legend-color-box {
        width: 12px;
        height: 12px;
        border-radius: 2px;
    }

    /* ================================================================== */
    /* CORREÇÃO: FIXA O CABEÇALHO COMPLETO DA TABELA DE DETALHAMENTO */
    /* ================================================================== */
    #tabela-detalhe-vendas thead th {
        position: sticky; /* Habilita o comportamento "grudento" */
        z-index: 2;       /* Garante que o cabeçalho fique sobre o corpo */
        background-color: #2c3846; /* Garante fundo sólido para não ver o texto rolando por baixo */
    }

    /* Define a posição de cada linha do cabeçalho */
    #tabela-detalhe-vendas thead tr:nth-child(1) th {
        top: 0; /* A primeira linha (Nomes das Lojas) gruda no topo */
    }
    #tabela-detalhe-vendas thead tr:nth-child(2) th {
        top: 45px; /* A segunda linha (Datas) gruda 45px abaixo do topo (altura da primeira linha) */
    }
    #tabela-detalhe-vendas thead tr:nth-child(3) th {
        top: 90px; /* A terceira linha (Pçs/$) gruda 90px abaixo (altura das duas primeiras) */
    }

/* ================================================================== */
/*        REGRAS DE LAYOUT RESPONSIVO (MOBILE) - VERSÃO MELHORADA     */
/* ================================================================== */

@media (max-width: 768px) {

    /* --- AJUSTES GERAIS DE ESPAÇAMENTO --- */
    .app-container { padding: 10px; }
    .filters-container { flex-direction: column; gap: 20px; padding: 20px; }


    /* --- 1. MELHORIAS NO CABEÇALHO PRINCIPAL (HEADER) --- */

    /* Container principal do header */
    .main-header {
        flex-direction: column; /* Mantém o empilhamento dos blocos */
        align-items: flex-start; /* ALINHA TUDO À ESQUERDA */
        gap: 20px;
        padding: 20px;
    }

    /* Bloco de Logos e Título */
    .header-title-container {
        flex-direction: column; /* Empilha logos e título */
        align-items: flex-start; /* Alinha o conteúdo à esquerda */
        gap: 15px;
    }
    
    /* ADICIONADO: Container apenas para as logos */
    .header-logos {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    /* Bloco de Controles (Navegação e Botões) */
    .header-controls {
        flex-direction: column; /* Empilha a navegação e os botões de ação */
        align-items: flex-start; /* Alinha tudo à esquerda */
        width: 100%;
        gap: 15px;
    }

   /* Transforma a lista <ul> em um container de grid */
    .main-header nav ul {
        display: grid; /* Usa o layout de Grid */
        grid-template-columns: 1fr 1fr; /* Cria duas colunas de largura igual */
        gap: 10px; /* Espaço entre os botões */
        width: 140%; /* Ocupa toda a largura disponível */
        padding: 0; /* Remove o padding padrão da lista */
    }

    /* Faz o item da lista <li> ocupar todo o espaço do seu grid-cell */
    .main-header nav li {
        display: contents; /* Remove o <li> do fluxo de layout, passando as propriedades do grid para o <a> */
    }

    /* Estiliza o botão <a> para preencher o espaço e centralizar o texto */
    .main-header nav a {
        width: 100%; /* Ocupa 100% da largura da célula do grid */
        text-align: center; /* Centraliza o texto dentro do botão */
        box-sizing: border-box; /* Garante que o padding não afete a largura total */
    }
    
    /* ADICIONADO: Container para os botões de Tema e Sair */
    .header-action-buttons {
        display: flex;
        gap: 15px;
    }


    /* --- AJUSTES NOS GRÁFICOS --- */

    /* Mantém 1 gráfico por fileira */
    .cards-container,
    .charts-container,
    .charts-container-3-cols {
        grid-template-columns: 1fr;
        gap: 20px;
    }

    /* 2. SCROLL HORIZONTAL PARA GRÁFICOS DE LINHA */
    #venda-dia-container,
    #venda-semana-container {
        overflow-x: auto; /* Adiciona o scroll no eixo X */
        -webkit-overflow-scrolling: touch;
    }
    /* Força o canvas a ter uma largura mínima para que o scroll funcione */
    #venda-dia-chart,
    #venda-semana-chart {
        min-width: 600px;
    }

    /* 3. ALTURA CORRETA PARA GRÁFICOS MENSAL/ANUAL */
    .charts-row {
        flex-direction: column; /* Empilha os gráficos */
    }
    .chart-wrapper-flex {
        height: 450px; /* Define a mesma altura dos outros gráficos de barra */
    }



    /* --- 5. AJUSTES NOS FORMULÁRIOS (VENDAS, LOJAS) --- */
    
    /* Garante 1 campo por fileira */
    form {
        grid-template-columns: 1fr;
    }
    .form-vendas-grid .form-actions,
    .form-actions-loja-ajustado {
        grid-column: 1 / -1;
        justify-content: center;
    }
    /* Garante que os campos de lançamento de venda fiquem em ordem */
    #form-lancamento .form-group {
        grid-column: 1 / -1; /* Força cada campo a ocupar a linha inteira */
    }


    /* --- 6. AJUSTES NAS TABELAS --- */

    .table-container {
        overflow-x: auto; /* Garante o scroll lateral */
        -webkit-overflow-scrolling: touch;
    }
    th, td {
        padding: 12px 10px;
        font-size: 0.9rem;
    }
    /* Ajustes específicos para a tabela de detalhamento */
    #tabela-detalhe-vendas th, 
    #tabela-detalhe-vendas td { min-width: 60px; }
    #tabela-detalhe-vendas .row-header-dia { min-width: 120px; }


    /* --- AJUSTES NA TELA DE LOGIN (sem alterações nesta rodada) --- */
    .login-screen-wrapper { display: block; padding: 20px 0; animation: none; }
    .login-page-container { flex-direction: column; margin: 20px auto; }
    .login-container { padding: 30px; }
    .login-image-container { max-height: 250px; }
}



</style>
</head>
<body>

    <!-- ======================= TELA DE LOGIN (HTML) ======================= -->
    <div id="login-screen" class="login-screen-wrapper">
        <div class="login-page-container">
            <div class="login-container">
                <header class="login-header">
                    <img src="https://victorpaulovichbueno-gif.github.io/logo-HAO/logohao" alt="Logo Haojue" style="height: 40px;">
                    <img src="https://assets.decocache.com/cvlbinsticiona/883934cf-cd5a-4b86-ac4c-d3504faa99ab/logo-inst-desk.svg" alt="Logo Casa & Vídeo" style="height: 45px;">
                </header>
                <h1>Controle de Vendas</h1>
                <p>Acesse para gerenciar suas operações.</p>
                <form id="login-form">
                    <div id="login-error" class="hidden">Login ou senha inválidos.</div>
                    <div class="form-group">
                        <label for="username">Login:</label>
                        <!-- REMOVIDO o value="ricardo" e ADICIONADO autocomplete="off" -->
                        <input type="text" id="username" name="username" required autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="password">Senha:</label>
                        <!-- REMOVIDO o value="123" e ADICIONADO autocomplete="new-password" -->
                        <input type="password" id="password" name="password" required autocomplete="new-password">
                    </div>
                    <button type="submit">Entrar</button>
                </form>

            </div>
            <div class="login-image-container">
                <img src="https://victorpaulovichbueno-gif.github.io/FOTO-HAO/unnamed.jpg" alt="Moto Elétrica Macchina" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
        </div>
    </div>

    <!-- ======================= TELA PRINCIPAL (HTML  ) ======================= -->
    <div id="app-screen" class="app-container hidden">
        <header class="main-header">
            <div class="header-title-container">
                <img src="https://victorpaulovichbueno-gif.github.io/logo-HAO/logohao" alt="Logo Haojue" style="height: 35px;">
                <img src="https://assets.decocache.com/cvlbinsticiona/883934cf-cd5a-4b86-ac4c-d3504faa99ab/logo-inst-desk.svg" alt="Logo Casa & Vídeo" style="height: 40px;">
                <h2>Controle de Venda</h2>
            </div>
            <div class="header-controls">
                <nav>
                    <!-- ========================================================== -->
                    <!--     VOLTANDO PARA UMA LISTA ÚNICA DE BOTÕES (HTML)         -->
                    <!-- ========================================================== -->
                    <ul>
                        <li><a href="#dashboard" class="nav-tab active-tab" data-tab="dashboard">Dashboard</a></li>
                        <li><a href="#vendas" class="nav-tab" data-tab="vendas">Vendas</a></li>
                        <li><a href="#lojas" class="nav-tab" data-tab="lojas">Lojas</a></li>
                        <li><a href="#produtos" class="nav-tab" data-tab="produtos">Produtos</a></li>
                    </ul>
                </nav>

                <button id="theme-toggle-btn" title="Alternar tema">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.7.79z"></path></svg>
                </button>
                <button id="logout-btn">Sair</button>
            </div>
        </header>

        <main>
            <!-- SEÇÃO 1: DASHBOARD -->
            <section id="dashboard" class="tab-content active-content">
                <div class="filters-container">
                    <div class="filter-group">
                        <label for="filter-month">Mês:</label>
                        <select id="filter-month"></select>
                        <label for="filter-year">Ano:</label>
                        <select id="filter-year"></select>
                    </div>
                </div>
                <div class="cards-container">
                    <div class="card"><h3 id="card-venda-total-label">Venda Total</h3><p id="card-venda-total">R$ 0,00</p></div>
                    <div class="card"><h3 id="card-unidades-label">Unidades</h3><p id="card-unidades">0</p></div>
                    <div class="card"><h3 id="card-ticket-medio-label">Ticket Médio</h3><p id="card-ticket-medio">R$ 0,00</p></div>
                    <div class="card"><h3 id="card-venda-media-label">Venda Média/Dia</h3><p id="card-venda-media">R$ 0,00</p></div>
                </div>
                
                <div class="charts-container-3-cols">
                    <div class="chart-wrapper chart-wrapper-tall"><div class="chart-title">Ranking de Unidades Vendidas por Modelo</div><canvas id="ranking-modelo-chart"></canvas></div>
                    <div class="chart-wrapper chart-wrapper-tall"><div class="chart-title"> Ranking de Unidades Vendidas por Loja</div><canvas id="ranking-lojas-chart"></canvas></div>
                    <div class="chart-wrapper chart-wrapper-tall"><div class="chart-title">Share de Vendas por Loja</div><canvas id="participacao-lojas-chart"></canvas></div>
                </div>
                <div class="charts-container-3-cols">
                    <div class="chart-wrapper chart-wrapper-tall"><div class="chart-title">Unidades Vendidas por Tipo de Loja</div><canvas id="venda-tipo-loja-chart"></canvas></div>
                    <div class="chart-wrapper chart-wrapper-tall"><div class="chart-title">Unidades Vendidas por GRC</div><canvas id="ranking-grc-chart"></canvas></div>
                    <div class="chart-wrapper chart-wrapper-tall"><div class="chart-title">Unidades Vendidas por Forma de Pagamento</div><canvas id="venda-forma-pagamento-chart"></canvas></div>
                </div>
                <!-- GRÁFICOS TEMPORAIS UNIFICADOS -->
                <!-- GRÁFICOS TEMPORAIS UNIFICADOS -->
                <div class="charts-container">
                    <div class="chart-wrapper">
                        <!-- Cabeçalho com Título e Botões -->
                        <div class="chart-header-controls">
                            <!-- ALTERAÇÃO: Removido o style="text-align: left;" -->
                            <div id="temporal-chart-title" class="chart-title" style="margin-bottom: 0;">Venda por Dia</div>
                            <div class="chart-toggle-buttons">
                                <button id="toggle-dia-btn" class="toggle-btn active">Dia</button>
                                <button id="toggle-semana-btn" class="toggle-btn">Semana</button>
                            </div>
                        </div>

                        <!-- Contêiner para os Canvas (um visível, outro escondido) -->
                        <div id="venda-dia-container" class="chart-canvas-container">
                            <canvas id="venda-dia-chart"></canvas>
                        </div>
                        <div id="venda-semana-container" class="chart-canvas-container hidden">
                            <canvas id="venda-semana-chart"></canvas>
                        </div>
                    </div>
                </div>


                                <!-- GRÁFICOS MENSAL E ANUAL NA MESMA LINHA -->
                <div class="charts-row">
                    <!-- Gráfico Mensal ocupando 2/3 -->
                    <div class="chart-wrapper-flex" style="flex: 2;">
                        <div class="chart-title">Venda Mensal</div>
                        <div class="chart-canvas-container">
                            <canvas id="venda-mensal-chart"></canvas>
                        </div>
                    </div>
                    <!-- Gráfico Anual ocupando 1/3 -->
                    <div class="chart-wrapper-flex" style="flex: 1;">
                        <div class="chart-title">Venda Anual</div>
                        <div class="chart-canvas-container">
                             <canvas id="venda-anual-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- ================================================================== -->
                <!-- NOVA VISÃO: DETALHAMENTO DE VENDAS (LAYOUT AJUSTADO) -->
                <!-- ================================================================== -->
                <div class="table-wrapper" style="margin-top: 25px; padding: 25px;">
                    
                    <!-- Título da Tabela -->
                    <h2 id="detalhe-vendas-titulo" style="font-size: 1.2rem; margin: 0 0 5px 0;">Detalhamento de Vendas</h2>
                    
                    <!-- Legenda (Subtítulo) -->
                    <div class="table-legend" style="margin-bottom: 20px;">
                        <span class="legend-item"><span class="legend-color-box" style="background-color: #ffab00;"></span> Dia de Inauguração</span>
                    </div>

                    <!-- Contêiner da Tabela Matriz -->
                    <div class="table-container" style="max-height: none; overflow-x: auto;">
                        <table id="tabela-detalhe-vendas">
                            <thead id="detalhe-vendas-head"></thead>
                            <tbody id="detalhe-vendas-body"></tbody>
                        </table>
                    </div>
                </div>

                        
                    
                    <!-- Contêiner da Tabela Matriz -->
                    <div class="table-container" style="max-height: 900px; overflow-x: auto;">
                        <table id="tabela-detalhe-vendas">
                            <thead id="detalhe-vendas-head"></thead>
                            <tbody id="detalhe-vendas-body"></tbody>
                        </table>
                    </div>




            </section>

            <!-- SEÇÃO 2: VENDAS -->
            <section id="vendas" class="tab-content">
                <form id="form-lancamento" class="form-vendas-grid">
                    <h2 id="venda-form-title">Lançar Nova Venda</h2>
                    <input type="hidden" id="venda-edit-id">
                    
                    <div class="form-group"><label for="venda-data">Data</label><input type="date" id="venda-data" required></div>
                    <div class="form-group"><label for="venda-loja">Loja</label><select id="venda-loja" required></select></div>
                    <div class="form-group">
                        <label for="venda-tipo-loja-display">Tipo da Loja</label>
                        <input type="text" id="venda-tipo-loja-display" readonly>
                    </div>
                    <div class="form-group">
                        <label for="venda-modelo">Modelo Vendido</label>
                        <select id="venda-modelo" required></select>
                    </div>

                    <div class="form-group"><label for="venda-valor">Valor da Venda</label><input type="number" id="venda-valor" step="0.01" required></div>
                    <div class="form-group">
                        <label for="venda-forma-pagamento">Forma de Pagamento</label>
                        <select id="venda-forma-pagamento" required></select>
                    </div>
                    <div class="form-group"><label for="venda-quantidade">Quantidade</label><input type="number" id="venda-quantidade" value="1" min="1" required></div>
                    <div class="form-group"><label for="venda-total">Venda Total</label><input type="text" id="venda-total" readonly></div>

                    <div class="form-actions">
                        <button type="button" id="cancel-edit-venda-btn" class="hidden btn-cancel">Cancelar</button>
                        <button type="submit" id="venda-submit-btn">Lançar Venda</button>
                    </div>
                </form>
                <hr>
                
                <div class="table-header-controls">
                    <h2>Vendas Lançadas</h2>
                    <button id="export-vendas-btn">Exportar Vendas (CSV)</button>
                </div>
                
                <!-- ================================================================== -->
                <!-- BLOCO 1: ALTERAÇÃO NO HTML (Agrupamento dos Filtros de Vendas)   -->
                <!-- ================================================================== -->

                <div class="filters-container">
                    <div class="filter-group">
                        <div class="form-group">
                            <label for="vendas-filter-data">Data:</label>
                            <input type="date" id="vendas-filter-data">
                        </div>
                        <div class="form-group">
                            <label for="vendas-filter-loja">Loja:</label>
                            <select id="vendas-filter-loja"><option value="">Todas</option></select>
                        </div>
                    </div>
                    <button id="clear-vendas-filters-btn" class="btn-cancel">Limpar Filtros</button>
                </div>


                <div class="table-wrapper">
                    <div class="table-container">
                        <table id="tabela-vendas">
                            <thead><tr><th>Data</th><th>Loja</th><th>Modelo</th><th>Valor</th><th>Qtd</th><th>Venda Total</th><th>Ações</th></tr></thead>
                            <tbody id="tabela-vendas-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- SEÇÃO 3: LOJAS -->
            <section id="lojas" class="tab-content">
                <form id="form-cadastro-loja">
                    <h2 id="loja-form-title">Cadastrar Nova Loja</h2>
                    <div id="loja-success-msg" class="hidden"></div>
                    <div id="loja-error-msg" class="hidden"></div>
                    <input type="hidden" id="loja-edit-id">
                    <div class="form-group"><label for="loja-nome">Nome da Loja</label><input type="text" id="loja-nome" required></div>
                    <!-- ================================================================== -->
                    <!-- BLOCO 1: CORREÇÃO NO HTML (Formulário de Lojas)                  -->
                    <!-- ================================================================== -->

                    <div class="form-group">
                        <label for="loja-tipo">Tipo da Loja</label>
                        <select id="loja-tipo" required>
                            <option value="">Selecione o tipo</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Rua">Rua</option>
                        </select>
                    </div>

                    <div class="form-group"><label for="loja-data-inauguracao">Data de Inauguração</label><input type="date" id="loja-data-inauguracao" required></div>
                    <div class="form-group"><label for="loja-grc">GRC (Gerente)</label><input type="text" id="loja-grc" required></div>
                    <div class="form-actions-loja-ajustado">
                        <button type="button" id="cancel-edit-loja-btn" class="hidden btn-cancel">Cancelar</button>
                        <button type="submit" id="loja-submit-btn">Cadastrar Loja</button>
                    </div>
                </form>
                <hr>
                <h2>Lojas Cadastradas</h2>
                <h3 id="subtitulo-lojas" style="font-weight: 400; font-size: 1rem; margin-top: -15px; margin-bottom: 20px;"></h3>
                <div class="table-wrapper">
                    <table id="tabela-lojas">
                        <thead><tr><th>Loja</th><th>Bloco</th><th>Data Inauguração</th><th>GRC (Gerente)</th><th>Ações</th></tr></thead>
                        <tbody id="tabela-lojas-body"></tbody>
                    </table>
                </div>
            </section>

            <!-- SEÇÃO 4: PRODUTOS -->
            <section id="produtos" class="tab-content">
                <h2>Produtos Cadastrados</h2>
                <div class="table-wrapper">
                    <table id="tabela-produtos">
                        <thead>
                            <tr>
                                <th>Modelo</th>
                                <th>Valor</th>
                                <th>Ação</th>
                                <th>Última Alteração</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="produtos-lista-body"></tbody>
                    </table>
                </div>
            </section>

        </main>
    </div>

    <!-- MODAL DE CONFIRMAÇÃO -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <p id="modal-message">Deseja confirmar esta ação?</p>
            <div class="modal-actions">
                <button id="modal-cancel-btn" class="btn-cancel">Cancelar</button>
                <button id="modal-confirm-btn">Confirmar</button>
            </div>
        </div>
    </div>

<script>
// ======================= LÓGICA DA APLICAÇÃO (JAVASCRIPT) =======================
// --- INÍCIO DA CONFIGURAÇÃO DO FIREBASE ---

// Cole aqui o objeto firebaseConfig que você copiou do console do Firebase
const firebaseConfig = {
  apiKey:  "AIzaSyC3IdWlsK0uTBdhoTx82mUbQwdfo9xtGVs",
  authDomain:  "projeto-hao.firebaseapp.com",
  projectId: "projeto-hao",
  storageBucket: "projeto-hao.firebasestorage.app",
  messagingSenderId: "604279606354",
  appId:  "1:604279606354:web:95a784bfbdaa76f82b238b"
};

// Inicializa a aplicação do Firebase com as suas chaves
firebase.initializeApp(firebaseConfig);
// Pega uma referência ao serviço do banco de dados (Firestore)
const db = firebase.firestore();

// --- FIM DA CONFIGURAÇÃO DO FIREBASE ---

document.addEventListener('DOMContentLoaded', () => {
    
    // ADICIONE ESTAS CONSTANTES
    const toggleDiaBtn = document.getElementById('toggle-dia-btn');
    const toggleSemanaBtn = document.getElementById('toggle-semana-btn');
    const vendaDiaContainer = document.getElementById('venda-dia-container');
    const vendaSemanaContainer = document.getElementById('venda-semana-container');
    const temporalChartTitle = document.getElementById('temporal-chart-title');

    // --- ELEMENTOS DO DOM ---
    const loginScreen = document.getElementById('login-screen');
    const appScreen = document.getElementById('app-screen');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');
    const logoutButton = document.getElementById('logout-btn');
    const themeToggleButton = document.getElementById('theme-toggle-btn');

    const navTabs = document.querySelectorAll('.nav-tab');
    const tabContents = document.querySelectorAll('.tab-content');

    // Elementos da Seção Lojas
    const lojaForm = document.getElementById('form-cadastro-loja');
    const lojaFormTitle = document.getElementById('loja-form-title');
    const lojaEditId = document.getElementById('loja-edit-id');
    const lojaSubmitBtn = document.getElementById('loja-submit-btn');
    const cancelEditLojaBtn = document.getElementById('cancel-edit-loja-btn');
    const tabelaLojasBody = document.getElementById('tabela-lojas-body');
    const subtituloLojas = document.getElementById('subtitulo-lojas');
    const lojaSuccessMsg = document.getElementById('loja-success-msg');
    const lojaErrorMsg = document.getElementById('loja-error-msg');
    
    // Elementos da Seção Vendas
    const formLancamento = document.getElementById('form-lancamento');
    const vendaFormTitle = document.getElementById('venda-form-title');
    const vendaEditId = document.getElementById('venda-edit-id');
    const vendaSubmitBtn = document.getElementById('venda-submit-btn');
    const cancelEditVendaBtn = document.getElementById('cancel-edit-venda-btn');
    const vendaLojaSelect = document.getElementById('venda-loja');
    const vendaDataInput = document.getElementById('venda-data');
    const tabelaVendasBody = document.getElementById('tabela-vendas-body');
    const vendaFormaPagamentoSelect = document.getElementById('venda-forma-pagamento');
    const vendaValorInput = document.getElementById('venda-valor');
    const vendaQuantidadeInput = document.getElementById('venda-quantidade');
    const vendaTotalInput = document.getElementById('venda-total');
    const vendaModeloSelect = document.getElementById('venda-modelo');
    const vendaTipoLojaDisplay = document.getElementById('venda-tipo-loja-display');

    // Elementos da Seção Produtos
    const produtosListaBody = document.getElementById('produtos-lista-body');
    const modal = document.getElementById('confirm-modal');
    const modalMessage = document.getElementById('modal-message');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');


    // Elementos de Filtros
    const filterMonth = document.getElementById('filter-month');
    const filterYear = document.getElementById('filter-year');
    const exportVendasBtn = document.getElementById('export-vendas-btn');
    const vendasFilterData = document.getElementById('vendas-filter-data');
    const vendasFilterLoja = document.getElementById('vendas-filter-loja');
    const clearVendasFiltersBtn = document.getElementById('clear-vendas-filters-btn');

    // --- BANCO DE DADOS (localStorage) e ESTADO DA SESSÃO ---
    let lojas = [];
    let vendas = [];

    let produtos = []; // Array será inicializado na função initializeApp
    let charts = {};
    let lojasSelecionadasIds = []; // <<<< ADICIONE ESTA LINHA

    // --- LÓGICA DE TEMA (MODO ESCURO) ---
    const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
    const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;

   
    // ADICIONE ESTAS CONSTANTES
    const detalheVendasHead = document.getElementById('detalhe-vendas-head');
    const detalheVendasBody = document.getElementById('detalhe-vendas-body');
    const detalheVendasTitulo = document.getElementById('detalhe-vendas-titulo');
    const lojasCheckboxesContainer = document.getElementById('lojas-checkboxes');
    const detalheLojaFilter = document.getElementById('detalhe-loja-filter');

    async function loadDataFromFirebase() {
    console.log("Iniciando carregamento de dados do Firebase...");
    
    // Cria "promessas" para buscar cada coleção de dados ao mesmo tempo.
    const lojasPromise = db.collection('lojas').get();
    const vendasPromise = db.collection('vendas').get();
    const produtosPromise = db.collection('produtos').get();

    // Espera todas as buscas terminarem.
    const [lojasSnapshot, vendasSnapshot, produtosSnapshot] = await Promise.all([
        lojasPromise,
        vendasPromise,
        produtosPromise
    ]);

    // Processa os resultados e preenche nossos arrays locais.
    lojas = lojasSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    vendas = vendasSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    produtos = produtosSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    lojasSelecionadasIds = lojas.map(l => l.id);

    console.log("Dados carregados:", { lojas, vendas, produtos });

    // Após carregar tudo, renderiza a aplicação.
    renderAll();
}


    function applyTheme(theme  ) {
        if (theme === 'dark') {
            document.body.classList.add('dark-mode');
            themeToggleButton.innerHTML = sunIcon;
            localStorage.setItem('theme', 'dark');
        } else {
            document.body.classList.remove('dark-mode');
            themeToggleButton.innerHTML = moonIcon;
            localStorage.setItem('theme', 'light');
        }
        if (Object.keys(charts).length > 0) {
            updateDashboard();
        }
    }

    themeToggleButton.addEventListener('click', () => {
        const currentTheme = localStorage.getItem('theme') || 'light';
        applyTheme(currentTheme === 'light' ? 'dark' : 'light');
    });

    // --- LÓGICA DE AUTENTICAÇÃO E SESSÃO ---
    function checkLogin() {
        applyTheme(localStorage.getItem('theme'));
        if (sessionStorage.getItem('loggedIn') === 'true') {
            showApp();
        } else {
            showLogin();
        }
    }

    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        if (username === 'hao' && password === '123') {
            sessionStorage.setItem('loggedIn', 'true');
        
        location.reload();
        loadDataFromLocalStorage();
        } else {
            loginError.classList.remove('hidden');
        }
    });

    logoutButton.addEventListener('click', () => {
        sessionStorage.removeItem('loggedIn');
        showLogin();
    });

    function showLogin() {
        appScreen.classList.add('hidden');
        loginScreen.classList.remove('hidden');
        applyTheme(localStorage.getItem('theme'));
    }

    function showApp() {
    loginScreen.classList.add('hidden');
    appScreen.classList.remove('hidden');
    
    // Primeiro, configura os elementos da página (navegação, formulários, etc.)
    initializeApp(); 
    
    // Em seguida, chama a função para carregar os dados do banco de dados online.
    // A função renderAll() será chamada de dentro da loadDataFromFirebase quando os dados chegarem.
    loadDataFromFirebase();
}


    // --- INICIALIZAÇÃO DA APLICAÇÃO PRINCIPAL ---
    function initializeApp() {
        // Inicializa a lista de produtos (limpa dados antigos)
        const produtosIniciais = [
            { id: 1, modelo: 'Harlley 16', valor: 0, ativo: true, ultimaAlteracao: null },
            { id: 2, modelo: 'Grazie', valor: 0, ativo: true, ultimaAlteracao: null },
            { id: 3, modelo: 'Retro', valor: 0, ativo: true, ultimaAlteracao: null },
            { id: 4, modelo: 'Maggie', valor: 0, ativo: true, ultimaAlteracao: null },
            { id: 5, modelo: 'Vitte Plus', valor: 0, ativo: true, ultimaAlteracao: null },
            { id: 6, modelo: 'Felice Duo', valor: 0, ativo: true, ultimaAlteracao: null },
            { id: 7, modelo: 'Veux', valor: 0, ativo: true, ultimaAlteracao: null },
            { id: 8, modelo: 'Bella', valor: 0, ativo: true, ultimaAlteracao: null },
            { id: 9, modelo: 'Macchina', valor: 0, ativo: true, ultimaAlteracao: null }
        ];
        // Mantém os valores e status já salvos, se existirem
        const produtosSalvos = JSON.parse(localStorage.getItem('produtos')) || [];
        produtos = produtosIniciais.map(pInicial => {
            const pSalvo = produtosSalvos.find(p => p.id === pInicial.id);
            return pSalvo ? pSalvo : pInicial;
        });
        localStorage.setItem('produtos', JSON.stringify(produtos));

        setupNavigation();
        setupForms();
        setupProdutosInteractivity();
        populateFilters();
        

        // ADICIONE ESTE BLOCO DE CÓDIGO
        toggleDiaBtn.addEventListener('click', () => {
            vendaDiaContainer.classList.remove('hidden');
            vendaSemanaContainer.classList.add('hidden');
            toggleDiaBtn.classList.add('active');
            toggleSemanaBtn.classList.remove('active');
            temporalChartTitle.textContent = 'Venda por Dia';
        });

        toggleSemanaBtn.addEventListener('click', () => {
            vendaDiaContainer.classList.add('hidden');
            vendaSemanaContainer.classList.remove('hidden');
            toggleDiaBtn.classList.remove('active');
            toggleSemanaBtn.classList.add('active');
            temporalChartTitle.textContent = 'Venda por Semana';
        });
        renderAll();
    }

    // --- NAVEGAÇÃO POR ABAS ---
    function setupNavigation() {
        navTabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                navTabs.forEach(t => t.classList.remove('active-tab'));
                tab.classList.add('active-tab');
                const target = tab.getAttribute('data-tab');
                tabContents.forEach(content => {
                    content.classList.remove('active-content');
                    if (content.id === target) {
                        content.classList.add('active-content');
                    }
                });
                resetLojaForm();
                resetVendaForm();
            });
        });
    }

    // --- CONFIGURAÇÃO DOS FORMULÁRIOS ---
    function setupForms() {
        // Lógica do formulário de Lojas
        cancelEditLojaBtn.addEventListener('click', resetLojaForm);
        // ALTERAÇÃO: A função agora é async para poder esperar a resposta do Firebase
        lojaForm.onsubmit = async (e) => {
            e.preventDefault();
            const id = lojaEditId.value;
            const nomeLoja = document.getElementById('loja-nome').value;

            // A validação de duplicados continua a mesma
            const isDuplicate = lojas.some(l => l.nome.toLowerCase() === nomeLoja.toLowerCase() && l.id != id);
            if (isDuplicate) {
                lojaErrorMsg.textContent = `A loja "${nomeLoja}" já está cadastrada.`;
                lojaErrorMsg.classList.remove('hidden');
                lojaSuccessMsg.classList.add('hidden');
                return;
            }

            const lojaData = {
                nome: nomeLoja,
                tipo: document.getElementById('loja-tipo').value,
                dataInauguracao: document.getElementById('loja-data-inauguracao').value,
                grc: document.getElementById('loja-grc').value
            };

            try {
                if (id) {
                    // MODO EDIÇÃO: Atualiza o documento existente no Firebase
                    await db.collection('lojas').doc(id).update(lojaData);
                } else {
                    // MODO CADASTRO: Adiciona um novo documento ao Firebase
                    await db.collection('lojas').add(lojaData);
                }

                // Após salvar, recarrega os dados do Firebase para atualizar a tela
                await loadDataFromFirebase();
                
                resetLojaForm();
                lojaSuccessMsg.textContent = id ? 'Loja atualizada com sucesso!' : 'Loja cadastrada com sucesso!';
                lojaSuccessMsg.classList.remove('hidden');
                lojaErrorMsg.classList.add('hidden');
                setTimeout(() => lojaSuccessMsg.classList.add('hidden'), 3000);

            } catch (error) {
                console.error("Erro ao salvar loja no Firebase:", error);
                lojaErrorMsg.textContent = 'Ocorreu um erro ao salvar a loja. Verifique o console.';
                lojaErrorMsg.classList.remove('hidden');
            }
        };


        // Lógica do formulário de Vendas
        cancelEditVendaBtn.addEventListener('click', resetVendaForm);
        vendaDataInput.valueAsDate = new Date();
        vendaLojaSelect.onchange = () => {
            const loja = lojas.find(l => l.id == vendaLojaSelect.value);
            vendaTipoLojaDisplay.value = loja ? `Bloco ${loja.tipo}` : '';
        };
        
        vendaModeloSelect.onchange = () => {
            const produto = produtos.find(p => p.modelo === vendaModeloSelect.value);
            if (produto) {
                vendaValorInput.value = produto.valor;
                vendaValorInput.dispatchEvent(new Event('input'));
            }
        };
        
        const formasPagamento = ["Dinheiro", "Pix", "Crédito 1x", "Crédito 2x", "Crédito 3x", "Crédito 4x", "Crédito 5x", "Crédito 6x", "Crédito 7x", "Crédito 8x", "Crédito 9x", "Crédito 10x", "Crédito 11x", "Crédito 12x"];
        vendaFormaPagamentoSelect.innerHTML = formasPagamento.map(f => `<option value="${f}">${f}</option>`).join('');

        const calcularVendaTotal = () => {
            const valor = parseFloat(vendaValorInput.value) || 0;
            const qtd = parseInt(vendaQuantidadeInput.value) || 0;
            vendaTotalInput.value = (valor * qtd).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };
        vendaValorInput.addEventListener('input', calcularVendaTotal);
        vendaQuantidadeInput.addEventListener('input', calcularVendaTotal);

// >>>>> COLE ESTE NOVO CÓDIGO NO LUGAR DO ANTIGO <<<<<
        formLancamento.onsubmit = async (e) => {
            e.preventDefault();

            const modeloSelecionado = vendaModeloSelect.value;
            const produto = produtos.find(p => p.modelo === modeloSelecionado);

            if (produto && !produto.ativo) {
                alert(`O modelo "${modeloSelecionado}" encontra-se INATIVO na base de produtos e não pode ser lançado.`);
                return;
            }

            const id = vendaEditId.value;
            const lojaSelecionada = lojas.find(l => l.id == vendaLojaSelect.value);
            
            const vendaData = {
                data: vendaDataInput.value,
                lojaId: vendaLojaSelect.value,
                tipoLoja: lojaSelecionada ? lojaSelecionada.tipo : '',
                modelo: vendaModeloSelect.value,
                valor: parseFloat(vendaValorInput.value),
                formaPagamento: vendaFormaPagamentoSelect.value,
                quantidade: parseInt(vendaQuantidadeInput.value)
            };

            try {
                if (id) {
                    // MODO EDIÇÃO: Atualiza o documento de venda no Firebase
                    await db.collection('vendas').doc(id).update(vendaData);
                } else {
                    // MODO CADASTRO: Adiciona um novo documento de venda no Firebase
                    await db.collection('vendas').add(vendaData);
                }

                // Após salvar, recarrega todos os dados para atualizar os dashboards e tabelas
                await loadDataFromFirebase();
                
                resetVendaForm();
                // Poderíamos adicionar uma mensagem de sucesso aqui se quiséssemos

            } catch (error) {
                console.error("Erro ao salvar venda no Firebase:", error);
                alert("Ocorreu um erro ao salvar a venda. Verifique o console para mais detalhes.");
            }
        };


        exportVendasBtn.addEventListener('click', () => {
            const vendasParaExportar = getFilteredVendasTabela().map(venda => {
                const loja = lojas.find(l => l.id == venda.lojaId);
                return {
                    Data: venda.data,
                    Loja: loja ? loja.nome : 'N/A',
                    Modelo: venda.modelo,
                    Valor: venda.valor,
                    Quantidade: venda.quantidade,
                    Total: (venda.valor * venda.quantidade).toFixed(2)
                };
            });
            if (vendasParaExportar.length > 0) {
                exportToCsv('vendas.csv', vendasParaExportar);
            } else {
                alert('Nenhuma venda para exportar com os filtros atuais.');
            }
        });
        [vendasFilterData, vendasFilterLoja].forEach(el => el.onchange = renderTabelaVendas);
        clearVendasFiltersBtn.onclick = () => {
            vendasFilterData.value = '';
            vendasFilterLoja.value = '';
            renderTabelaVendas();
        };
    }

    // --- FUNÇÕES DE RESET DE FORMULÁRIO ---
    function resetLojaForm() {
        lojaForm.reset();
        lojaEditId.value = '';
        lojaForm.classList.remove('editing-mode');
        lojaFormTitle.textContent = 'Cadastrar Nova Loja';
        lojaSubmitBtn.textContent = 'Cadastrar Loja';
        cancelEditLojaBtn.classList.add('hidden');
        lojaErrorMsg.classList.add('hidden');
        lojaSuccessMsg.classList.add('hidden');
    }

    function resetVendaForm() {
        formLancamento.reset();
        vendaEditId.value = '';
        formLancamento.classList.remove('editing-mode');
        vendaFormTitle.textContent = 'Lançar Nova Venda';
        vendaSubmitBtn.textContent = 'Lançar Venda';
        cancelEditVendaBtn.classList.add('hidden');
        vendaDataInput.valueAsDate = new Date();
        vendaTotalInput.value = '';
        vendaTipoLojaDisplay.value = '';
    }

    // --- FUNÇÕES DE EDIÇÃO E EXCLUSÃO ---
    function editLoja(id) {
        const loja = lojas.find(l => l.id == id);
        if (!loja) return;
        lojaForm.classList.add('editing-mode');
        lojaEditId.value = loja.id;
        document.getElementById('loja-nome').value = loja.nome;
        document.getElementById('loja-tipo').value = loja.tipo;
        document.getElementById('loja-data-inauguracao').value = loja.dataInauguracao;
        document.getElementById('loja-grc').value = loja.grc;
        lojaFormTitle.textContent = 'Editando Loja';
        lojaSubmitBtn.textContent = 'Salvar Alteração';
        cancelEditLojaBtn.classList.remove('hidden');
        lojaForm.scrollIntoView({ behavior: 'smooth' });
    }

async function deleteLoja(id) {
    if (confirm('Tem certeza que deseja excluir esta loja? Todas as vendas associadas a ela perderão a referência.')) {
        try {
            await db.collection('lojas').doc(id).delete();
            await loadDataFromFirebase();
            console.log(`Loja com ID ${id} excluída com sucesso.`);
        } catch (error) {
            console.error("Erro ao excluir loja no Firebase:", error);
            alert("Ocorreu um erro ao tentar excluir a loja. Verifique o console.");
        }
    }
}


    function editVenda(id) {
        const venda = vendas.find(v => v.id == id);
        if (!venda) return;
        formLancamento.classList.add('editing-mode');
        vendaEditId.value = venda.id;
        vendaDataInput.value = venda.data;
        vendaLojaSelect.value = venda.lojaId;
        vendaLojaSelect.dispatchEvent(new Event('change')); // Atualiza o tipo
        vendaModeloSelect.value = venda.modelo;
        vendaValorInput.value = venda.valor;
        vendaFormaPagamentoSelect.value = venda.formaPagamento;
        vendaQuantidadeInput.value = venda.quantidade;
        vendaValorInput.dispatchEvent(new Event('input'));
        vendaFormTitle.textContent = 'Editando Venda';
        vendaSubmitBtn.textContent = 'Salvar Alteração';
        cancelEditVendaBtn.classList.remove('hidden');
        formLancamento.scrollIntoView({ behavior: 'smooth' });
    }

// ==================================================================
// VERSÃO CORRIGIDA DA FUNÇÃO DE EXCLUIR VENDA (COM FIREBASE)
// ==================================================================
async function deleteVenda(id) {
    // A confirmação do usuário continua igual
    if (confirm('Tem certeza que deseja excluir esta venda?')) {
        try {
            // 1. MANDA O COMANDO DE EXCLUSÃO PARA O FIREBASE
            // Pega a coleção 'vendas', encontra o documento com o 'id' e o deleta.
            await db.collection('vendas').doc(id).delete();

            // 2. RECARREGA TODOS OS DADOS DO FIREBASE
            // Isso garante que os arrays locais (vendas, lojas, etc.) fiquem 100% sincronizados
            // com o banco de dados, e redesenha a tela inteira.
            await loadDataFromFirebase();

            console.log(`Venda com ID ${id} excluída com sucesso.`);

        } catch (error) {
            console.error("Erro ao excluir venda no Firebase:", error);
            alert("Ocorreu um erro ao tentar excluir a venda. Verifique o console.");
        }
    }
}


    // --- FUNÇÕES DE RENDERIZAÇÃO DE TABELA ---
    function getFilteredVendasTabela() {
        const dataFiltro = vendasFilterData.value;
        const lojaFiltro = vendasFilterLoja.value;
        return vendas.filter(venda => {
            const dataMatch = !dataFiltro || venda.data === dataFiltro;
            const lojaMatch = !lojaFiltro || venda.lojaId == lojaFiltro;
            return dataMatch && lojaMatch;
        });
    }

    function renderTabelaVendas() {
        const vendasFiltradas = getFilteredVendasTabela();
        tabelaVendasBody.innerHTML = '';
        const vendasOrdenadas = [...vendasFiltradas].sort((a, b) => new Date(b.data) - new Date(a.data));
        
        vendasOrdenadas.forEach(venda => {
            const loja = lojas.find(l => l.id == venda.lojaId);
            const totalVenda = venda.valor * venda.quantidade;
            const row = `<tr>
                <td>${new Date(venda.data + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                <td>${loja ? loja.nome : 'N/A'}</td>
                <td>${venda.modelo}</td>
                <td>${venda.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                <td>${venda.quantidade}</td>
                <td>${totalVenda.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                <td class="actions-cell">
                    <button class="btn-table-action btn-table-edit" data-id="${venda.id}">Editar</button>
                    <button class="btn-table-action btn-table-delete" data-id="${venda.id}">Excluir</button>
                </td>
            </tr>`;
            tabelaVendasBody.innerHTML += row;
        });

        document.querySelectorAll('#tabela-vendas .btn-table-edit').forEach(b => b.onclick = (e) => editVenda(e.target.dataset.id));
        document.querySelectorAll('#tabela-vendas .btn-table-delete').forEach(b => b.onclick = (e) => deleteVenda(e.target.dataset.id));
    }

    /* ================================================================== */
    /* BLOCO 2: CORREÇÃO NO JAVASCRIPT (Tabela de Lojas)                */
    /* ================================================================== */

    function renderTabelaLojas() {
        // A lógica do subtítulo também precisa ser corrigida para contar "Shopping" e "Rua"
        const totalLojas = lojas.length;
        const lojasShopping = lojas.filter(l => l.tipo === 'Shopping').length;
        const lojasRua = lojas.filter(l => l.tipo === 'Rua').length;
        subtituloLojas.textContent = `${totalLojas} lojas cadastradas, sendo ${lojasShopping} de Shopping e ${lojasRua} de Rua.`;

        tabelaLojasBody.innerHTML = '';
        lojas.forEach(loja => {
            const row = `<tr>
                <td>${loja.nome}</td>
                <td>${loja.tipo}</td> <!-- CORREÇÃO AQUI -->
                <td>${new Date(loja.dataInauguracao + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                <td>${loja.grc}</td>
                <td class="actions-cell">
                    <button class="btn-table-action btn-table-edit" data-id="${loja.id}">Editar</button>
                    <button class="btn-table-action btn-table-delete" data-id="${loja.id}">Excluir</button>
                </td>
            </tr>`;
            tabelaLojasBody.innerHTML += row;
        });
        document.querySelectorAll('#tabela-lojas .btn-table-edit').forEach(b => b.onclick = (e) => editLoja(e.target.dataset.id));
        document.querySelectorAll('#tabela-lojas .btn-table-delete').forEach(b => b.onclick = (e) => deleteLoja(e.target.dataset.id));
    }

    
    // --- FUNÇÕES DE POPULAR SELECTS E FILTROS ---
    function populateLojasSelect() {
        vendaLojaSelect.innerHTML = '<option value="">Selecione a loja</option>';
        lojas.forEach(loja => {
            vendaLojaSelect.innerHTML += `<option value="${loja.id}">${loja.nome}</option>`;
        });
    }

    function populateProdutosSelect() {
        const produtosAtivos = produtos.filter(p => p.ativo);
        vendaModeloSelect.innerHTML = '<option value="">Selecione o modelo</option>';
        produtosAtivos.forEach(produto => {
            vendaModeloSelect.innerHTML += `<option value="${produto.modelo}">${produto.modelo}</option>`;
        });
    }

    function populateVendasFilters() {
        vendasFilterLoja.innerHTML = '<option value="">Todas</option>';
        lojas.forEach(loja => {
            vendasFilterLoja.innerHTML += `<option value="${loja.id}">${loja.nome}</option>`;
        });
    }

    function exportToCsv(filename, rows) {
        if (!rows || rows.length === 0) {
            return;
        }
        const processRow = row => Object.values(row).map(val => `"${String(val).replace(/"/g, '""')}"`).join(',');
        const csvContent = "data:text/csv;charset=utf-8," 
            + [Object.keys(rows[0]).join(','), ...rows.map(processRow)].join('\n');
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
/* ================================================================== */
/* BLOCO 2: ALTERAÇÃO NO JAVASCRIPT (Renderização da Tabela)        */
/* ================================================================== */

function renderProdutosLista() {
    produtosListaBody.innerHTML = '';
    produtos.forEach(produto => {
        const row = document.createElement('tr');
        const dataFormatada = produto.ultimaAlteracao 
            ? new Date(produto.ultimaAlteracao).toLocaleString('pt-BR')
            : 'Nunca';

        // ALTERAÇÃO: Ordem das células e conteúdo do botão de edição.
        row.innerHTML = `
            <td>${produto.modelo}</td>
            <td>
                <div class="produto-valor-container">
                    <span class="produto-valor-display">${produto.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                </div>
            </td>
            <td>
                <button class="edit-valor-btn" data-id="${produto.id}" title="Editar valor">✏️</button>
            </td>
            <td>${dataFormatada}</td>
            <td>
                <span class="status-dot ${produto.ativo ? 'ativo' : 'inativo'}" data-id="${produto.id}" title="${produto.ativo ? 'Ativo' : 'Inativo'}"></span>
            </td>
        `;
        produtosListaBody.appendChild(row);
    });
}


    function setupProdutosInteractivity() {
        // Lógica do modal de confirmação
        let confirmCallback = null;
        modalConfirmBtn.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            modal.classList.add('hidden');
        });
        modalCancelBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            renderProdutosLista();
        });
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
                renderProdutosLista();
            }
        });

// >>>>> COLE ESTE NOVO CÓDIGO NO LUGAR DO ANTIGO <<<<<
        produtosListaBody.addEventListener('click', async (e) => {
            const target = e.target;
            const produtoRow = target.closest('tr');
            if (!produtoRow) return;

            // A lógica de edição de valor agora é async
            if (target.closest('.edit-valor-btn')) {
                const editBtn = target.closest('.edit-valor-btn');
                const id = editBtn.dataset.id;
                const produto = produtos.find(p => p.id == id);
                if (!produto) return;

                const valorContainer = produtoRow.querySelector('.produto-valor-container');
                if (valorContainer.querySelector('input')) return;

                const valorDisplay = valorContainer.querySelector('.produto-valor-display');
                
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'produto-valor-input';
                input.value = produto.valor;
                
                valorDisplay.innerHTML = '';
                valorDisplay.appendChild(input);
                input.focus();
                input.select();

                const saveChanges = () => {
                    const novoValor = parseFloat(input.value);
                    if (!isNaN(novoValor) && novoValor >= 0 && novoValor !== produto.valor) {
                        modalMessage.textContent = `Deseja alterar o valor de venda do modelo "${produto.modelo}"?`;
                        modal.classList.remove('hidden');
                        
                        confirmCallback = async () => {
                            try {
                                // ATUALIZA O DOCUMENTO NO FIREBASE
                                await db.collection('produtos').doc(id).update({
                                    valor: novoValor,
                                    ultimaAlteracao: new Date().toISOString()
                                });
                                // Recarrega os dados para refletir a mudança
                                await loadDataFromFirebase();
                            } catch (error) {
                                console.error("Erro ao atualizar valor do produto:", error);
                                alert("Não foi possível atualizar o valor do produto.");
                            }
                        };
                    } else {
                        renderProdutosLista();
                    }
                };

                input.addEventListener('blur', saveChanges);
                input.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') input.blur();
                    else if (event.key === 'Escape') renderProdutosLista();
                });
            }

            // A lógica de mudança de status agora é async
            if (target.classList.contains('status-dot')) {
                const id = target.dataset.id;
                const produto = produtos.find(p => p.id == id);
                if (produto) {
                    try {
                        // ATUALIZA O DOCUMENTO NO FIREBASE
                        await db.collection('produtos').doc(id).update({
                            ativo: !produto.ativo
                        });
                        // Recarrega os dados para refletir a mudança
                        await loadDataFromFirebase();
                    } catch (error) {
                        console.error("Erro ao atualizar status do produto:", error);
                        alert("Não foi possível atualizar o status do produto.");
                    }
                }
            }
        });

    }

    // --- LÓGICA DO DASHBOARD ---
    function populateFilters() {
        const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        filterMonth.innerHTML = '<option value="all">Todos os Meses</option>';
        meses.forEach((mes, index) => {
            filterMonth.innerHTML += `<option value="${index}">${mes}</option>`;
        });
        const currentYear = new Date().getFullYear();
        filterYear.innerHTML = '<option value="all">Todos os Anos</option>';
        for (let i = currentYear; i >= currentYear - 5; i--) {
            filterYear.innerHTML += `<option value="${i}">${i}</option>`;
        }
        filterMonth.value = new Date().getMonth();
        filterYear.value = currentYear;
        filterMonth.onchange = updateDashboard;
        filterYear.onchange = updateDashboard;
    }
    
    function getFilteredVendas() {
        const selectedMonth = filterMonth.value;
        const selectedYear = filterYear.value;
        return vendas.filter(venda => {
            const vendaDate = new Date(venda.data + 'T00:00:00');
            const monthMatch = (selectedMonth === 'all') || (vendaDate.getMonth() == selectedMonth);
            const yearMatch = (selectedYear === 'all') || (vendaDate.getFullYear() == selectedYear);
            return monthMatch && yearMatch;
        });
    }

    function updateDashboard() {
        const vendasFiltradas = getFilteredVendas();
        const vendaTotal = vendasFiltradas.reduce((sum, v) => sum + (v.valor * v.quantidade), 0);
        const totalUnidades = vendasFiltradas.reduce((sum, v) => sum + v.quantidade, 0);
        const ticketMedio = totalUnidades > 0 ? vendaTotal / totalUnidades : 0;
        const diasUnicos = new Set(vendasFiltradas.map(v => v.data)).size;
        const vendaMediaDia = diasUnicos > 0 ? vendaTotal / diasUnicos : 0;

        document.getElementById('card-venda-total').textContent = vendaTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        document.getElementById('card-unidades').textContent = totalUnidades;
        document.getElementById('card-ticket-medio').textContent = ticketMedio.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        document.getElementById('card-venda-media').textContent = vendaMediaDia.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        
        updateRankingLojasChart(vendasFiltradas);
        updateRankingModeloChart(vendasFiltradas);
        updateVendaTipoLojaChart(vendasFiltradas);
        updateVendaFormaPagamentoChart(vendasFiltradas);
        updateRankingGRCChart(vendasFiltradas);
        updateParticipacaoChart(vendasFiltradas, totalUnidades);
        updateVendaDiaChart(vendasFiltradas);
        updateVendaSemanaChart(vendasFiltradas);
        updateVendaMensalChart();
        updateVendaAnualChart();
        updateDetalheVendasTable(vendasFiltradas);
    }

    function createChart(ctx, type, data, options) {
        const chartId = ctx.canvas.id;
        if (charts[chartId]) charts[chartId].destroy();
        
        const isDarkMode = document.body.classList.contains('dark-mode');
        const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const textColor = isDarkMode ? '#f0f2f5' : '#172B4D';
        Chart.defaults.color = textColor;
        Chart.register(ChartDataLabels);

        const defaultOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { 
                    ticks: { color: textColor, display: options.indexAxis === 'y' }, 
                    grid: { color: gridColor, drawBorder: false },
                    display: options.indexAxis === 'y'
                },
                x: { 
                    ticks: { color: textColor }, 
                    grid: { color: gridColor, drawBorder: false },
                    display: options.indexAxis !== 'y'
                }
            },
            plugins: {
                legend: { labels: { color: textColor } },
                datalabels: {
                    color: type === 'bar' ? '#fff' : (isDarkMode ? '#fff' : '#333'),
                    anchor: 'end',
                    align: 'end',
                    formatter: (value) => value > 0 ? value : ''
                }
            }
        };

        const finalOptions = { ...defaultOptions, ...options };
        if (options.scales) {
            finalOptions.scales.x = { ...defaultOptions.scales.x, ...options.scales.x };
            finalOptions.scales.y = { ...defaultOptions.scales.y, ...options.scales.y };
        }
        if (options.plugins && options.plugins.datalabels) {
            finalOptions.plugins.datalabels = { ...defaultOptions.plugins.datalabels, ...options.plugins.datalabels };
        }
        if (type === 'pie' || type === 'doughnut') {
            finalOptions.scales = { x: { display: false }, y: { display: false } };
        }

        charts[chartId] = new Chart(ctx, { type, data, options: finalOptions });
    }

    /* ================================================================== */
/* BLOCO ÚNICO: ALTERAÇÃO NO JAVASCRIPT (Habilitar Rótulos de Dados)  */
/* ================================================================== */

function updateRankingModeloChart(vendasFiltradas) {
    const ctx = document.getElementById('ranking-modelo-chart').getContext('2d');
    const vendasPorModelo = vendasFiltradas.reduce((acc, v) => {
        acc[v.modelo] = (acc[v.modelo] || 0) + v.quantidade;
        return acc;
    }, {});
    const sorted = Object.entries(vendasPorModelo).sort(([, a], [, b]) => b - a).slice(0, 10);

    const gradient = ctx.createLinearGradient(0,0, 0, ctx.canvas.height); // Gradiente horizontal
    gradient.addColorStop(0, '#191013'); // Cor inicial (esquerda, mais clara)
    gradient.addColorStop(1, '#15191d'); // Cor final (direita, mais escura)

    createChart(ctx, 'bar', {
        labels: sorted.map(([nome]) => nome),
        datasets: [{
            label: 'Unidades Vendidas',
            data: sorted.map(([, qtd]) => qtd),
            backgroundColor: gradient,
            borderRadius: 18
        }]
    }, { 
        indexAxis: 'y', 
        plugins: { 
            legend: { display: false },
            datalabels: {
                color: '#fff',
                anchor: 'center', // Centraliza o rótulo na barra
                align: 'center'
            }
        } 
    });
}

function updateRankingLojasChart(vendasFiltradas) {
    const ctx = document.getElementById('ranking-lojas-chart').getContext('2d');
    const vendasPorLoja = vendasFiltradas.reduce((acc, v) => {
        const loja = lojas.find(l => l.id == v.lojaId);
        if (loja) acc[loja.nome] = (acc[loja.nome] || 0) + v.quantidade;
        return acc;
    }, {});
    const sortedLojas = Object.entries(vendasPorLoja).sort(([, a], [, b]) => b - a);

    const gradient = ctx.createLinearGradient(0,0, 0, ctx.canvas.height); // Gradiente horizontal
    gradient.addColorStop(1, '#f7a21b'); // Cor inicial (esquerda, mais clara)
    gradient.addColorStop(0, '#faba32'); // Cor final (direita, mais escura)

    createChart(ctx, 'bar', {
        labels: sortedLojas.map(([nome]) => nome),
        datasets: [{
            label: 'Unidades Vendidas',
            data: sortedLojas.map(([, qtd]) => qtd),
            backgroundColor: gradient,
            borderRadius: 18
        }]
    }, { 
        indexAxis: 'y', 
        plugins: { 
            legend: { display: false },
            datalabels: {
                color: '#fff',
                anchor: 'center',
                align: 'center'
            }
        } 
    });
}

/* ================================================================== */
/* BLOCO ÚNICO: ALTERAÇÃO NO JAVASCRIPT (Participação em Percentual) */
/* ================================================================== */

function updateParticipacaoChart(vendasFiltradas) {
    const ctx = document.getElementById('participacao-lojas-chart').getContext('2d');
    
    // 1. Calcula a venda total em VALOR (R$), que será o nosso 100%.
    const vendaTotalValor = vendasFiltradas.reduce((sum, v) => sum + (v.valor * v.quantidade), 0);

    // 2. Agrupa as vendas por loja somando o VALOR.
    const vendasPorLoja = vendasFiltradas.reduce((acc, v) => {
        const loja = lojas.find(l => l.id == v.lojaId);
        if (loja) {
            acc[loja.nome] = (acc[loja.nome] || 0) + (v.valor * v.quantidade);
        }
        return acc;
    }, {});

    const sorted = Object.entries(vendasPorLoja).sort(([, a], [, b]) => b - a);
    
    const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
    const isDarkMode = document.body.classList.contains('dark-mode');
        gradient.addColorStop(1, '#4b538b'); // Cor inicial (esquerda, mais clara)
        gradient.addColorStop(0, '#4b538b'); // Cor final (direita, mais escura)
    createChart(ctx, 'bar', {
        labels: sorted.map(([nome]) => nome),
        datasets: [{
            label: 'Participação (%)', // Label atualizado
            // 3. ALTERAÇÃO: Os dados agora são os percentuais calculados.
            data: sorted.map(([, val]) => vendaTotalValor > 0 ? (val / vendaTotalValor * 100) : 0),
            backgroundColor: gradient,
            borderRadius: 18
        }]
    }, {
        indexAxis: 'y',
        plugins: {
            legend: { display: false },
            // 4. ALTERAÇÃO: Rótulo de dados agora formata como percentual.
            datalabels: {
                color: '#fff',
                anchor: 'center',
                align: 'center',
                formatter: (value) => value > 0 ? `${value.toFixed(1)}%` : '' // Ex: 25.5%
            },
            tooltip: {
                callbacks: {
                    // Tooltip agora mostra o valor em R$ e o %
                    label: (c) => {
                        // Para obter o valor original em R$, precisamos buscá-lo novamente
                        const lojaNome = c.label;
                        const valorOriginal = vendasPorLoja[lojaNome] || 0;
                        const valorFormatado = valorOriginal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                        return `${c.dataset.label}: ${c.raw.toFixed(2)}% (${valorFormatado})`;
                    }
                }
            }
        },
        // 5. ALTERAÇÃO: Adiciona o sufixo '%' ao eixo X.
        scales: {
            x: {
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        }
    });
}




function updateDetalheVendasTable(vendasFiltradas) {

    
    const meses = ["JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"];
    const diasSemana = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
    const selectedMonth = parseInt(filterMonth.value);
    const selectedYear = parseInt(filterYear.value);

    const mesNome = selectedMonth !== 'all' ? meses[selectedMonth] : 'PERÍODO';
    detalheVendasTitulo.textContent = `Detalhamento de Vendas - ${mesNome}`;



   const lojasAtivas = [...lojas].sort((a,b) => a.nome.localeCompare(b.nome));


    // --- INÍCIO DA ALTERAÇÃO: CÁLCULO E RENDERIZAÇÃO DO TOTALIZADOR ---

    // 1. CALCULAR TOTAIS POR LOJA E O TOTAL GERAL
    const totaisPorLoja = {};
    let totalGeralPcs = 0;
    let totalGeralValor = 0;

    lojasAtivas.forEach(loja => {
        const vendasDaLoja = vendasFiltradas.filter(v => v.lojaId == loja.id);
        const totalPcs = vendasDaLoja.reduce((sum, v) => sum + v.quantidade, 0);
        const totalValor = vendasDaLoja.reduce((sum, v) => sum + (v.valor * v.quantidade), 0);
        totaisPorLoja[loja.id] = { pcs: totalPcs, valor: totalValor };
        totalGeralPcs += totalPcs;
        totalGeralValor += totalValor;
    });

    // 2. AJUSTAR A CONSTRUÇÃO DO CABEÇALHO PARA INCLUIR A NOVA LINHA
    // A primeira célula do cabeçalho agora ocupa 4 linhas (rowspan="4")
    let headerHTML = '<tr><th rowspan="4" class="row-header-dia">DATA</th>';
    
    if (lojasAtivas.length > 0) {
        lojasAtivas.forEach(loja => { headerHTML += `<th colspan="2" class="col-header-loja">${loja.nome}</th>`; });
        headerHTML += '<th colspan="2" class="col-header-loja">TOTAL</th></tr><tr>';
        
        lojasAtivas.forEach(loja => {
            const dataInaug = new Date(loja.dataInauguracao + 'T00:00:00').toLocaleDateString('pt-BR');
            headerHTML += `<th colspan="2">${dataInaug}</th>`;
        });
        headerHTML += '<th colspan="2"></th></tr>';
        
        // **NOVA LINHA DE TOTALIZADORES**
        headerHTML += '<tr>';
        lojasAtivas.forEach(loja => {
            const total = totaisPorLoja[loja.id];
            headerHTML += `<th class="sub-header">${total.pcs}</th><th class="sub-header">${total.valor.toLocaleString('pt-BR')}</th>`;
        });
        // Adiciona o total geral
        headerHTML += `<th class="sub-header">${totalGeralPcs}</th><th class="sub-header">${totalGeralValor.toLocaleString('pt-BR')}</th>`;
        headerHTML += '</tr>';
        
        // Linha de "Pçs" e "$"
        headerHTML += '<tr>';
        lojasAtivas.forEach(() => { headerHTML += '<th class="sub-header">Pçs</th><th class="sub-header">$</th>'; });
        headerHTML += '<th class="sub-header">Pçs</th><th class="sub-header">$</th>';
    }
    headerHTML += '</tr>';
    detalheVendasHead.innerHTML = headerHTML;
    
    // --- FIM DA ALTERAÇÃO ---

    // O corpo da tabela permanece o mesmo
    const diasDoMes = (selectedMonth === 'all' || selectedYear === 'all') 
        ? [...new Set(vendasFiltradas.map(v => v.data))].sort()
        : Array.from({ length: new Date(selectedYear, selectedMonth + 1, 0).getDate() }, (_, i) => `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}-${String(i + 1).padStart(2, '0')}`);

    let bodyHTML = '';
    if (lojasAtivas.length > 0) {
        diasDoMes.forEach(dataString => {
            const dateObj = new Date(dataString + 'T00:00:00');
            const dia = dateObj.getDate();
            const diaSemanaNome = diasSemana[dateObj.getUTCDay()];
            let totalDiaPcs = 0;
            let totalDiaValor = 0;
            
            let rowHTML = `<tr><td class="row-header-dia">${dia} - ${diaSemanaNome.toUpperCase()}</td>`;

            lojasAtivas.forEach(loja => {
                const vendasDiaLoja = vendasFiltradas.filter(v => v.data === dataString && v.lojaId == loja.id);
                const pcs = vendasDiaLoja.reduce((sum, v) => sum + v.quantidade, 0);
                const valor = vendasDiaLoja.reduce((sum, v) => sum + (v.valor * v.quantidade), 0);
                const isDiaInauguracao = loja.dataInauguracao === dataString;
                const classeInauguracao = isDiaInauguracao ? 'inauguracao-cell' : '';
                rowHTML += `<td class="${classeInauguracao}">${pcs > 0 ? pcs : ''}</td><td class="${classeInauguracao}">${valor > 0 ? valor.toLocaleString('pt-BR') : ''}</td>`;
                totalDiaPcs += pcs;
                totalDiaValor += valor;
            });

            rowHTML += `<td>${totalDiaPcs > 0 ? totalDiaPcs : ''}</td><td>${totalDiaValor > 0 ? totalDiaValor.toLocaleString('pt-BR') : ''}</td></tr>`;
            bodyHTML += rowHTML;
        });
    }
    detalheVendasBody.innerHTML = bodyHTML;
}


/* ================================================================== */
/* BLOCO ÚNICO: CORREÇÃO NO JAVASCRIPT (Ordem de Definição de ctx)    */
/* ================================================================== */

function updateVendaTipoLojaChart(vendasFiltradas) {
    // 1. CORREÇÃO: A linha que define 'ctx' foi movida para o início.
    const ctx = document.getElementById('venda-tipo-loja-chart').getContext('2d');
    const totalUnidades = vendasFiltradas.reduce((sum, v) => sum + v.quantidade, 0);
    if (totalUnidades === 0) { if(charts[ctx.canvas.id]) charts[ctx.canvas.id].destroy(); return; }

    const vendasPorTipo = vendasFiltradas.reduce((acc, v) => {
        const loja = lojas.find(l => l.id == v.lojaId);
        if (loja) acc[`Bloco ${loja.tipo}`] = (acc[`Bloco ${loja.tipo}`] || 0) + v.quantidade;
        return acc;
    }, {});
    const sorted = Object.entries(vendasPorTipo).sort(([, a], [, b]) => b - a);
    
    // 2. CORREÇÃO: Agora 'ctx' já existe quando estas linhas são executadas.
    const chartArea = ctx.canvas.getBoundingClientRect();
    const centerX = chartArea.width / 2;
    const centerY = chartArea.height / 2;
    const outerRadius = Math.min(centerX, centerY);

    const createRadialGradient = (color1, color2) => {
        const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, outerRadius);
        gradient.addColorStop(0, color2);
        gradient.addColorStop(1, color1);
        return gradient;
    };

    const gradientBlue = createRadialGradient('#4b538b', '#4b538b');
    const gradientGreen = createRadialGradient('#a5c8ca', '#a5c8ca');
    const gradientYellow = createRadialGradient('#ffab00', '#FFC400');

    createChart(ctx, 'pie', {
        labels: sorted.map(([tipo]) => tipo),
        datasets: [{
            data: sorted.map(([, qtd]) => qtd),
            backgroundColor: [gradientBlue, gradientGreen, gradientYellow],
            borderColor: document.body.classList.contains('dark-mode') ? '#111111' : '#ffffff',
            borderWidth: 0
        }]
    }, {
        plugins: {
            legend: { position: 'bottom' },
                        datalabels: {
                color: '#fff',
                anchor: 'center', // Ancorar o rótulo no centro da fatia
                align: 'center',  // Alinhar o texto no centro da âncora
                formatter: (value) => {
                    const percent = (value / totalUnidades * 100).toFixed(1);
                    return `${percent}%`; // Mostra apenas o percentual
                },
                font: { 
                    weight: 'bold',
                    size: 11 // Aumenta um pouco o tamanho da fonte para melhor leitura
                }
            }
            // ==================================================================
            // FIM DA ALTERAÇÃO
            // ==================================================================
        },
        cutout: '50%' 
    });
}


function updateVendaFormaPagamentoChart(vendasFiltradas) {
    const ctx = document.getElementById('venda-forma-pagamento-chart').getContext('2d');
    const vendasPorForma = vendasFiltradas.reduce((acc, v) => {
        acc[v.formaPagamento] = (acc[v.formaPagamento] || 0) + v.quantidade;
        return acc;
    }, {});
    const sorted = Object.entries(vendasPorForma).sort(([, a], [, b]) => b - a);
    
    const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
    const isDarkMode = document.body.classList.contains('dark-mode');
        gradient.addColorStop(1, '#f7a21b'); // Cor inicial (esquerda, mais clara)
        gradient.addColorStop(0, '#f7a21b'); // Cor final (direita, mais escura)

    createChart(ctx, 'bar', {
        labels: sorted.map(([nome]) => nome),
        datasets: [{
            label: 'Unidades Vendidas',
            data: sorted.map(([, qtd]) => qtd),
            backgroundColor: gradient,
            borderRadius: 18
        }]
    }, {
        indexAxis: 'y',
        plugins: { 
            legend: { display: false },
            datalabels: {
                color: '#fff',
                anchor: 'center',
                align: 'center'
            }
        }
    });
}

function updateRankingGRCChart(vendasFiltradas) {
    const ctx = document.getElementById('ranking-grc-chart').getContext('2d');
    const vendasPorGRC = vendasFiltradas.reduce((acc, v) => {
        const loja = lojas.find(l => l.id == v.lojaId);
        if (loja && loja.grc) acc[loja.grc] = (acc[loja.grc] || 0) + v.quantidade;
        return acc;
    }, {});
    const sorted = Object.entries(vendasPorGRC).sort(([, a], [, b]) => b - a);

    const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
        gradient.addColorStop(1, '#15191d'); // Cor inicial (esquerda, mais clara)
        gradient.addColorStop(0, '#15191d'); // Cor final (direita, mais escura)

    createChart(ctx, 'bar', {
        labels: sorted.map(([grc]) => grc),
        datasets: [{
            data: sorted.map(([, qtd]) => qtd),
            label: 'Unidades Vendidas',
            backgroundColor: gradient,
            borderRadius: 18
        }]
    }, { 
        indexAxis: 'y',
        plugins: { 
            legend: { display: false },
            datalabels: {
                color: '#fff',
                anchor: 'center',
                align: 'center'
            }
        } 
    });
}

function updateVendaDiaChart(vendasFiltradas) {
    const ctx = document.getElementById('venda-dia-chart').getContext('2d');
    const vendasPorDia = vendasFiltradas.reduce((acc, v) => {
        acc[v.data] = (acc[v.data] || 0) + (v.valor * v.quantidade);
        return acc;
    }, {});
    const sorted = Object.entries(vendasPorDia).sort(([a], [b]) => new Date(a) - new Date(b));

    const isDarkMode = document.body.classList.contains('dark-mode');

    // O gradiente não é mais necessário para a cor de fundo principal
    // const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
    // ...

    const options = {
        plugins: {
            legend: { 
                display: false 
            },
            datalabels: {
                display: true,
                anchor: 'end',
                align: 'top',
                offset: 8,
                color: isDarkMode ? '#e0e0e0' : '#15191d',
                font: {
                    size: 10,
                    weight: 'bold'
                },
                formatter: (value) => value > 0 ? value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '',
                backgroundColor: isDarkMode ? 'rgba(40, 40, 40, 0.7)' : 'rgba(255, 255, 255, 0.7)',
                borderRadius: 4,
                padding: 4
            }
        },
        scales: {
            y: { grid: { display: true, drawBorder: false }, ticks: { display: true } },
            x: { grid: { display: false } }
        }
    };

    const data = {
        labels: sorted.map(([data]) => new Date(data + 'T00:00:00').toLocaleDateString('pt-BR')),
        datasets: [{
            label: 'Venda Total',
            data: sorted.map(([, val]) => val),
            
            // --- ALTERAÇÃO: Cores padronizadas para o azul ---
            borderColor: '#4b538b',             // Cor da LINHA
            backgroundColor: 'rgba(75, 83, 139, 0.5)', // Cor da ÁREA com 50% de transparência
            pointBackgroundColor: '#4b538b',   // Cor do MARCADOR (ponto)

            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: '#4b538b',
            pointRadius: 4,
            pointHoverRadius: 6,
            fill: true, // 'fill: true' usa o backgroundColor para preencher a área
            tension: 0.4
        }]
    };

    createChart(ctx, 'line', data, options);
}


function updateVendaSemanaChart(vendasFiltradas) {
    const ctx = document.getElementById('venda-semana-chart').getContext('2d');
    
    const getWeekOfMonth = (date) => {
        const firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
        const dayOfMonth = date.getDate();
        return Math.ceil((dayOfMonth + firstDayOfMonth) / 7);
    };

    const vendasPorSemana = vendasFiltradas.reduce((acc, v) => {
        const vendaDate = new Date(v.data + 'T00:00:00');
        const anoAbreviado = vendaDate.getFullYear().toString().slice(-2);
        const mesAbreviado = vendaDate.toLocaleString('pt-BR', { month: 'short' }).replace('.', '');
        const semanaDoMes = getWeekOfMonth(vendaDate);
        const chave = `${semanaDoMes}ª Sem de ${mesAbreviado}/${anoAbreviado}`;
        const sortKey = `${vendaDate.getFullYear()}-${String(vendaDate.getMonth()).padStart(2, '0')}-${semanaDoMes}`;

        if (!acc[sortKey]) {
            acc[sortKey] = { label: chave, value: 0 };
        }
        acc[sortKey].value += (v.valor * v.quantidade);
        return acc;
    }, {});

    const sorted = Object.values(vendasPorSemana).sort((a, b) => {
        const keyA = Object.keys(vendasPorSemana).find(key => vendasPorSemana[key].label === a.label);
        const keyB = Object.keys(vendasPorSemana).find(key => vendasPorSemana[key].label === b.label);
        return keyA.localeCompare(keyB);
    });

    const isDarkMode = document.body.classList.contains('dark-mode');

    // O gradiente não é mais necessário
    // const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
    // ...

    createChart(ctx, 'line', {
        labels: sorted.map(item => item.label),
        datasets: [{
            label: 'Venda Total',
            data: sorted.map(item => item.value),

            // --- ALTERAÇÃO: Cores padronizadas para o azul ---
            borderColor: '#4b538b',             // Cor da LINHA
            backgroundColor: 'rgba(75, 83, 139, 0.5)', // Cor da ÁREA com 50% de transparência
            pointBackgroundColor: '#4b538b',    // Cor do MARCADOR (ponto)

            fill: true, // 'fill: true' usa o backgroundColor para preencher a área
            tension: 0.4,
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: '#4b538b',
            pointRadius: 4,
            pointHoverRadius: 6
        }]
    }, {
        plugins: {
            legend: { display: false },
            datalabels: {
                display: true,
                anchor: 'end',
                align: 'top',
                offset: 8,
                color: isDarkMode ? '#e0e0e0' : '#15191d',
                font: {
                    size: 10,
                    weight: 'bold'
                },
                formatter: (value) => value > 0 ? value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '',
                backgroundColor: isDarkMode ? 'rgba(40, 40, 40, 0.7)' : 'rgba(255, 255, 255, 0.7)',
                borderRadius: 4,
                padding: 4
            }
        },
        scales: {
            y: { grid: { display: true, drawBorder: false }, ticks: { display: true } },
            x: { grid: { display: false } }
        }
    });
}

function updateVendaMensalChart() {
    const ctx = document.getElementById('venda-mensal-chart').getContext('2d');
    
    const vendasPorMes = vendas.reduce((acc, v) => {
        const vendaDate = new Date(v.data + 'T00:00:00');
        const chave = `${vendaDate.getFullYear()}-${String(vendaDate.getMonth()).padStart(2, '0')}`;
        acc[chave] = (acc[chave] || 0) + (v.valor * v.quantidade);
        return acc;
    }, {});

    const sorted = Object.entries(vendasPorMes).sort(([a], [b]) => a.localeCompare(b));

    const labels = sorted.map(([chave]) => {
        const [ano, mes] = chave.split('-');
        return new Date(ano, mes, 1).toLocaleString('pt-BR', { month: 'short', year: '2-digit' }).replace('. de', '');
    });
    const data = sorted.map(([, valor]) => valor);

    const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
    gradient.addColorStop(1, '#f7a21b ');
    gradient.addColorStop(0, '#f7a21b ');

    createChart(ctx, 'bar', {
        labels: labels,
        datasets: [{
            label: 'Venda Total',
            data: data,
            backgroundColor: gradient,
            borderRadius: 8
        }]
    }, {
        plugins: {
            legend: { display: false },
            // --- ALTERAÇÃO PARA DEIXAR OS RÓTULOS APARENTES ---
            datalabels: {
                // Define a cor do texto dinamicamente (preto no modo claro, branco no modo escuro)
                color: document.body.classList.contains('dark-mode') ? '#e8f5e9' : '#e8f5e9',
                anchor: 'center',     // "Âncora" do rótulo no final da barra (no topo)
                align: 'center',      // Alinha o rótulo ACIMA da âncora (para fora da barra)
                offset: 4,         // Adiciona um pequeno espaço de 4 pixels acima da barra
                font: {
                    weight: 'bold',
                    size: 11
                },
                // Formata o valor para '12.3k' (milhares)
                formatter: (value) => {
                    if (value > 0) {
                        return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    }
                    return '';
                }
            }
        }
    });
}


  function updateVendaAnualChart() {
    const ctx = document.getElementById('venda-anual-chart').getContext('2d');

    const vendasPorAno = vendas.reduce((acc, v) => {
        const ano = new Date(v.data + 'T00:00:00').getFullYear();
        acc[ano] = (acc[ano] || 0) + (v.valor * v.quantidade);
        return acc;
    }, {});

    const sorted = Object.entries(vendasPorAno).sort(([a], [b]) => a.localeCompare(b));

    const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
    gradient.addColorStop(1, '#15191d');
    gradient.addColorStop(0, '#15191d');

    createChart(ctx, 'bar', {
        labels: sorted.map(([ano]) => ano),
        datasets: [{
            label: 'Venda Total',
            data: sorted.map(([, val]) => val),
            backgroundColor: gradient,
            borderRadius: 8
        }]
    }, {
        plugins: {
            legend: { display: false },
            // --- ALTERAÇÃO PARA DEIXAR OS RÓTULOS APARENTES ---
            datalabels: {
                // Define a cor do texto dinamicamente
                color: document.body.classList.contains('dark-mode') ? '#e8f5e9' : '#e8f5e9',
                anchor: 'center',     // Âncora no topo da barra
                align: 'center',      // Alinha para fora da barra
                offset: 4,         // Espaçamento acima da barra
                font: {
                    weight: 'bold',
                    size: 11
                },
                // Formata o valor para '12.3k' (milhares)
                formatter: (value) => {
                    if (value > 0) {
                        return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    }
                    return '';
                }
            }
        }
    });
}

    // --- FUNÇÃO DE RENDERIZAÇÃO INICIAL ---
    function renderAll() {
        renderTabelaLojas();
        renderProdutosLista();
        populateLojasSelect();
        populateProdutosSelect();
        populateVendasFilters();
        renderTabelaVendas();
        updateDashboard();
    }

    // --- PONTO DE ENTRADA DA APLICAÇÃO ---
    checkLogin();
});



</script>

</body>
</html>


